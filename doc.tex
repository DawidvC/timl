\documentclass{article}

\usepackage[landscape, margin=0.2in]{geometry}
\usepackage{amsmath,amsfonts,amscd,amssymb,proof,MnSymbol}
\usepackage{mathpartir}
\usepackage{turnstile}% http://ctan.org/pkg/turnstile
\usepackage{adjustbox}% http://ctan.org/pkg/adjustbox
\usepackage{color}

\renewcommand{\makehor}[4]
  {\ifthenelse{\equal{#1}{n}}{\hspace{#3}}{}
   \ifthenelse{\equal{#1}{s}}{\rule[-0.5#2]{#3}{#2}}{}
   \ifthenelse{\equal{#1}{d}}{\setlength{\lengthvar}{#2}
     \addtolength{\lengthvar}{0.5#4}
     \rule[-\lengthvar]{#3}{#2}
     \hspace{-#3}
     \rule[0.5#4]{#3}{#2}}{}
   \ifthenelse{\equal{#1}{t}}{\setlength{\lengthvar}{1.5#2}
     \addtolength{\lengthvar}{#4}
     \rule[-\lengthvar]{#3}{#2}
     \hspace{-#3}
     \rule[-0.5#2]{#3}{#2}
     \hspace{-#3}
     \setlength{\lengthvar}{0.5#2}
     \addtolength{\lengthvar}{#4}
     \rule[\lengthvar]{#3}{#2}}{}
   \ifthenelse{\equal{#1}{w}}{% New wavy $\sim$ definition
     \setbox0=\hbox{$\sim$}%
     \raisebox{-.6ex}{\hspace*{-.05ex}\adjustbox{width=#3,height=\height}{\clipbox{0.75 0 0 0}{\usebox0}}}}{}
  }

\newcommand{\thide}[1]{\left \langle #1 \right \rangle}
\newcommand{\typing}[4]{\turnstile{s}{s}{#4}{#3}{n}#1:#2}
\newcommand{\kinding}[2]{\turnstile{s}{s}{}{}{n}#1:#2}
\newcommand{\teq}[2]{#1\equiv#2}
\newcommand{\arrow}[4]{#1\xrightarrow[#3]{#2}#4}
\newcommand{\bottom}{\perp}
\newcommand{\symlet}{\mathsf{let\;}}
\newcommand{\symin}{\mathsf{\;in\;}}
\newcommand{\symletrec}{\mathsf{letrec\;}}
\newcommand{\symand}{\mathsf{\;and\;}}
\newcommand{\symmatch}{\mathsf{match}}
\newcommand{\FV}{\mathsf{FV}}
\newcommand{\symwith}{\mathsf{\;with\;}}
\newcommand{\symleft}{\mathsf{left}}
\newcommand{\symright}{\mathsf{right}}
\newcommand{\symmax}{\mathsf{max}}
\newcommand{\symSleft}{\mathsf{Sleft\;}}
\newcommand{\symSright}{\mathsf{Sright\;}}
\newcommand{\symfold}{\mathsf{fold\;}}
\newcommand{\symSfold}{\mathsf{Sfold\;}}
\newcommand{\symunfold}{\mathsf{unfold\;}}
\newcommand{\symSunfold}{\mathsf{Sunfold\;}}
\newcommand{\symhide}{\mathsf{hide\;}}
\newcommand{\symShide}{\mathsf{Shide\;}}
\newcommand{\symunhide}{\mathsf{unhide\;}}
\newcommand{\symSunhide}{\mathsf{Sunhide\;}}
\newcommand{\leO}{\preceq}
\newcommand{\sympair}{\mathsf{pair}}
\newcommand{\symtt}{\mathsf{tt}}
\newcommand{\symunit}{\mathsf{unit}}
\newcommand{\symlist}{\mathsf{list}}
\newcommand{\symnil}{\mathsf{nil}}
\newcommand{\symcons}{\mathsf{cons}}
\newcommand{\symfix}{\mathsf{fix}}
\newcommand{\symbool}{\mathsf{bool}}
\newcommand{\symtrue}{\mathsf{true}}
\newcommand{\symfalse}{\mathsf{false}}
\newcommand{\symmerge}{\mathsf{merge}}

%% \newcommand{\intro}[2]{#2^#1}
\newcommand{\intro}[2]{(#1 : #2)}
%% \newcommand{\intro}[2]{(#2 \mathsf{\;size\;} #1)}
%% \newcommand{\intro}[2]{\{#2 \mathsf{\;|\;} #1\}}

\newcommand{\symsum}{\mathsf{sum}}
\newcommand{\symfst}{\mathsf{fst}}
\newcommand{\symsnd}{\mathsf{snd}}
\newcommand{\symif}{\mathsf{if\;}}
\newcommand{\symthen}{\mathsf{\;then\;}}
\newcommand{\symelse}{\mathsf{\;else\;}}
\newcommand{\symSbool}{\mathsf{Sbool}}
\newcommand{\symuf}{\mathsf{uf}}
\newcommand{\symuh}{\mathsf{uh}}
\newcommand{\syml}{\mathsf{l}}
\newcommand{\symr}{\mathsf{r}}
\newcommand{\symf}{\mathsf{f}}
\newcommand{\syms}{\mathsf{s}}
\newcommand{\symmsort}{\mathsf{msort}}
\newcommand{\symSstat}{\mathsf{Sstat}}
\newcommand{\symsplit}{\mathsf{split}}
\newcommand{\symprod}{\mathsf{prod}}
\newcommand{\symStt}{\mathsf{Stt}}
\newcommand{\symSpair}{\mathsf{Spair}}
\newcommand{\symSlr}{\mathsf{Slr}}
\newcommand{\defeq}{\triangleq}

\begin{document}

\title{Lambda-O : lambda calculus with asymptotic complexity}
\author{Peng Wang}

\maketitle

\section{Plan}

$$
\mathrm{Type\;Checker}\xrightarrow[\mathrm{Task\;3}]{\mathrm{Soundness\;\&\;Completeness}}\mathrm{Type\;System}\xrightarrow[\mathrm{Task\;1}]{\mathrm{Soundness}}\mathrm{Operational\;Semantics\;(Evaluation\;Rules)}\xrightarrow[\mathrm{Task\;2}]{\mathrm{Complexity\;Preserving\;Compilation}}\mathrm{Assembly}
$$

\section{Syntax}

%% \begin{figure}
  $$\begin{array}{rrcl}
  \textrm{Size Subpart Indices} & i &::=& \symf \textrm{(fst)} \mid \syms \textrm{(snd)} \mid \syml \textrm{(left)} \mid \symr \textrm{(right)} \mid \symuf \textrm{(unfold)} \mid \symuh \textrm{(unhide)} \\
  \textrm{Complexity Expr.} & n &::=& x.\vec{i}.1 \mid x.\vec{i}.2 \mid 0 \mid 1 \mid n+n \mid n-n \mid n\times n \mid n/n \mid \log(n) \mid \exp(n) \\
  \textrm{Sizes} & s &::=& x.\vec{i} \mid \symSstat(n_1,n_2) \mid \symStt \mid \symSleft\;s \mid \symSright\;s \mid \symSlr\;s\;s \mid \symSpair\;s\;s \mid \symSfold\;s \mid \symShide\;s \\
  \textrm{Type Constants} & c_t &::=& \symunit \mid \symprod \mid \symsum \\
  \textrm{Types} & \tau &::=& X \mid c_t \mid \arrow{\intro{x}{\tau}}{n}{s}{\tau} \mid \forall^n_s X.\tau \mid \Lambda X.\tau \mid \tau\;\tau \mid \mu X.\tau \mid \thide\tau \\
  \textrm{Constants} & c &::=& \symtt \mid \sympair \mid \symleft \mid \symright \\
  \textrm{Expressions} & e &::=& x \mid c \mid e\;e \mid \lambda x:\tau.e \mid \symlet x:\tau:= e \symin e \mid \symletrec f_1:\tau_1:=e_1 \symand \cdots \symand f_m:\tau_m:=e_m \symin e \mid \symmatch_\sympair\;e\symwith (x,y)\Rightarrow e \\
  & & & \mid (\symmatch_\symsum\;e\symwith\symleft\;x\Rightarrow e\;|\;\symright\;x\Rightarrow e) \mid e\;\tau \mid \lambda X.e \mid \symfold\tau\;e \mid \symunfold\tau\;e \mid \symhide\;e \mid \symunhide\;e \\
  \textrm{Values} & v &::=& \lambda x:\tau.e \mid \lambda X.e \mid \symfold\tau e \\
  \textrm{Context} & C &::=& \Box \mid C\;e \mid v\;C \mid \symlet x:\tau:=C\symin e \mid \symletrec f_1:\tau_1:=e_1 \symand \cdots \symand f_m:\tau_m:=e_m \symin C \mid \symmatch_\sympair\;C\symwith(x,y)\Rightarrow e \\
  & & & \mid (\symmatch_\symsum\;C\symwith\symleft\;x\Rightarrow e\;|\;\symright\;x\Rightarrow e) \mid C\;\tau \mid \symfold\tau\;C \mid \symunfold\tau\;C \mid \symhide\;C \mid \symunhide\;C \\
  \textrm{Kinds} & k &::=& * \mid *\to k
\end{array}$$
%% \caption{\label{syntax}Syntax}
%% \end{figure}

\section{Evaluation rules}

\begin{mathpar}

\inferrule*
{e_1\to e_2}
{C[e_1]\to C[e_2]}

\inferrule*
{\;}
{(\lambda x:\tau.e)\;v \to e[v/x]}

\inferrule*
{\;}
{\symlet x:\tau:=v \symin e \to e[v/x]}

\inferrule*
{\;}
{\symletrec f_1:\tau_1:=e_1 \symand \cdots \symand f_m:\tau_m:=e_m \symin C[f_i] \to \symletrec f_1:\tau_1:=e_1 \symand \cdots \symand f_m:\tau_m:=e_m \symin C[e_i]}

\inferrule*
{\;}
{\symletrec f_1:\tau_1:=e_1 \symand \cdots \symand f_m:\tau_m:=e_m \symin v \to v}

\inferrule*
{\;}
{\symmatch_\sympair\;(v_1,v_2)\symwith(x,y)\Rightarrow e \to e[v_1/x][v_2/y]}

\inferrule*
{\;}
{\symmatch_\symsum\;\symleft\;v\symwith\symleft\;x\Rightarrow e_1\;|\;\symright\;x\Rightarrow e_2 \to e_1[v/x]}

\inferrule*
{\;}
{\symmatch_\symsum\;\symright\;v\symwith\symleft\;x\Rightarrow e_1\;|\;\symright\;x\Rightarrow e_2 \to e_2[v/x]}

\inferrule*
{\;}
{(\lambda X.e)\;\tau \to e[\tau/X]}

\inferrule*
{\;}
{\symunfold\tau_2\;(\symfold\tau_1\;v) \to v}

\inferrule*
{\;}
{\symunhide(\symhide v) \to v}

\end{mathpar}

\section{Kinging and Type equivalent rules}

\begin{mathpar}

\inferrule*
{\Gamma(X)=k}
{\Gamma\kinding{X}{k}}

\inferrule*
{\Gamma\kinding{\tau_1}{*\to k} \\ \Gamma\kinding{\tau_2}{*}}
{\Gamma\kinding{\tau_1\;\tau_2}{k}}

\inferrule*
{\Gamma,X:*\kinding{\tau}{k}}
{\Gamma\kinding{\Lambda X.\tau}{*\to k}}

\inferrule*
{\Gamma\kinding{\tau_1}{*} \\ \Gamma\kinding{\tau_2}{*}}
{\Gamma\kinding{\arrow{\tau_1}{n}{s}{\tau_2}}{*}}

\inferrule*
{\Gamma,X:*\kinding{\tau}{*}}
{\Gamma\kinding{\forall X.\tau}{*}}

\inferrule*
{\Gamma,X:*\kinding{\tau}{*}}
{\Gamma\kinding{\mu X.\tau}{*}}

\inferrule*
{\Gamma\kinding{\tau}{*}}
{\Gamma\kinding{\thide{\tau}}{*}}

\inferrule*
{\;}
{\Gamma\kinding{\symunit}{*}}

\inferrule*
{\;}
{\Gamma\kinding{\symprod}{*\to *\to *}}

\inferrule*
{\;}
{\Gamma\kinding{\symsum}{*\to *\to *}}

\end{mathpar}

\begin{mathpar}

\inferrule*
{\;}
{\teq{\tau}{\tau}}

\inferrule*
{\teq{\tau_1}{\tau_2} \\ \teq{\tau_2}{\tau_3}}
{\teq{\tau_1}{\tau_3}}

\inferrule*
{\teq{\tau_2}{\tau_1}}
{\teq{\tau_1}{\tau_2}}

\inferrule*
{\teq{\tau_1}{\tau_2}}
{\teq{\Lambda X.\tau_1}{\Lambda X.\tau_2}}

\inferrule*
{\teq{\tau_1}{\tau_1'} \\ \teq{\tau_2}{\tau_2'}}
{\teq{\tau_1\;\tau_2}{\tau_1'\;\tau_2'}}

\inferrule*
{\;}
{\teq{(\Lambda X.\tau_1)\;\tau_2}{\tau_1[\tau_2/X]}}

\inferrule*
{\teq{\tau_1}{\tau_1'} \\ \teq{\tau_2}{\tau_2'}}
{\teq{\arrow{\tau_1}{n}{s}{\tau_2}}{\arrow{\tau_1'}{n}{s}{\tau_2'}}}

\inferrule*
{\teq{\tau_1}{\tau_2}}
{\teq{\mu X.\tau_1}{\mu X.\tau_2}}

\end{mathpar}

\section{Typing rules}

%% \begin{figure}
\begin{mathpar}

\inferrule* [Right=Var] 
{\Gamma(x)=(\tau, s)} 
{\Gamma\typing{x}{\tau}{0}{s}} 

\inferrule* [Right=Var2] 
{\Gamma(x)=(\tau, \bottom)} 
{\Gamma\typing{x}{\tau}{0}{x}} 

\inferrule* [Right=App] 
{\Gamma\typing{e_1}{\arrow{\intro{x}{\tau_1}}{n}{s}{\tau_2}}{n_1}{s_1} \\ \Gamma\typing{e_2}{\tau_1}{n_2}{s_2} }
{\Gamma\typing{e_1\;e_2}{\tau_2}{n_1+n_2+1+n[s_2/x]}{s[s_2/x]}} 

\inferrule* [Right=Abs] 
{\Gamma\vdash\tau_1 : * \\ \Gamma, x:(\tau_1, \bottom)\typing{e}{\tau_2}{n}{s} }
{\Gamma\typing{\lambda x : \tau_1.\;e}{\arrow{\intro{x}{\tau_1}}{n}{s}{\tau_2}}{0}{1}} \\

\inferrule* [Right=Tapp]
{\Gamma\typing{e}{\forall X.\tau}{n}{s}}
{\Gamma\typing{e\;\tau_2}{\tau[\tau_2/X]}{n+1}{s}}

\inferrule* [Right=Tabs]
{\Gamma, X : * \typing{e}{\tau}{0}{1}}
{\Gamma\typing{\lambda X.e}{\forall X.\tau}{0}{1}} 

\inferrule* [Right=Let]
{\Gamma\typing{e_1}{\tau_1}{n_1}{s_1} \\ \Gamma, x : (\tau_1, s_1) \typing{e_2}{\tau_2}{n_2}{s_2}}
{\Gamma\typing{\symlet x : \tau_1 := e_1 \symin e_2}{\tau_2[s_1/x]}{n_1+n2[s_1/x]}{s_2[s_1/x]}}

\inferrule* [Right=Letrec]
{\Gamma' := \Gamma, f_1 : (\tau_1, 1), \dots, f_m : (\tau_m,1) \\ \forall i,\; \Gamma'\typing{e_i}{\tau_i}{0}{1} \\ \Gamma'\typing{e}{\tau}{n}{s} \\ \forall i,\; f_i\not\in\FV(\tau)\cup\FV(n)\cup\FV(s)}
{\Gamma\typing{\symletrec f_1 : \tau_1 := e_1 \symand \dots \symand f_m : \tau_m := e_m \symin e}{\tau}{n}{s}}

\inferrule* [Right=MatchPair]
{\Gamma\typing{e}{\tau_1\times\tau_2}{n}{s} \\ \mathsf{IsPair}(s)=(s_1,s_2) \\ \Gamma, a:(\tau_1,s_1), b:(\tau_2,s_2)\typing{e'}{\tau}{n'}{s'}}
{\Gamma\typing{\symmatch_\sympair\;e \symwith (a,b) \Rightarrow e'}{\tau[s1/a][s2/b]}{n + 1 + n'[s1/a][s2/b]}{s[s1/a][s2/b]}} \\

\inferrule* [Right=MatchLR]
{\Gamma\typing{e}{\tau_1+\tau_2}{n}{s} \\ \mathsf{IsLR}(s)=(s_1,s_2) \\ \forall i,\;\Gamma, x:(\tau_i,s_i)\typing{e_i}{\tau}{n_i}{s'} \\ x\not\in\FV(\tau)\cup\FV(s')}
{\Gamma\typing{\symmatch_\symsum\; e \symwith \symleft\;x \Rightarrow e_1 \;|\; \symright\;x \Rightarrow e_2}{\tau}{n+1+\symmax(n_1[s_1/x],n_2[s_2/x])}{s'}} \\

\inferrule* [Right=MatchL]
{\Gamma\typing{e}{\tau_1+\tau_2}{n}{\symSleft(s)} \\ \Gamma, x:(\tau_1,s)\typing{e_1}{\tau'}{n'}{s'}}
{\Gamma\typing{\symmatch_\symsum\; e \symwith \symleft\;x \Rightarrow e_1 \;|\; \symright\;x \Rightarrow e_2}{\tau'[s/x]}{n+1+n'[s/x]}{s'[s/x]}}

\inferrule* [Right=MatchR]
{\Gamma\typing{e}{\tau_1+\tau_2}{n}{\symSright(s)} \\ \Gamma, x:(\tau_2,s)\typing{e_2}{\tau'}{n'}{s'}}
{\Gamma\typing{\symmatch_\symsum\; e \symwith \symleft\;x \Rightarrow e_1 \;|\; \symright\;x \Rightarrow e_2}{\tau'[s/x]}{n+1+n'[s/x]}{s'[s/x]}} \\

\inferrule* [Right=Fold]
{\tau \equiv \mu X. \tau_1 \\ \Gamma\typing{e}{\tau_1[\tau/X]}{n}{s}}
{\Gamma\typing{\symfold \tau \; e}{\tau}{n}{\symSfold s}}

\inferrule* [Right=Unfold]
{\Gamma\typing{e}{t}{n}{s} \\ \mathsf{IsFold}(s)=s_1 \\ \tau \equiv \mu X.\tau_1}
{\Gamma\typing{\symunfold \tau\;e}{\tau_1[\tau/X]}{n}{s_1}}

\inferrule* [Right=Hide]
{\Gamma\typing{e}{\tau}{n}{s}}
{\Gamma\typing{\symhide e}{\thide{\tau}}{n}{\symShide s}} \\

\inferrule* [Right=Unhide]
{\Gamma\typing{e}{\thide{\tau}}{n}{s} \\ \mathsf{IsHide}(s)=s_1}
{\Gamma\typing{\symunhide e}{\tau}{n}{s_1}}

\inferrule* [Right=Eq]
{\Gamma\typing{e}{\tau_1}{n}{s} \\ \tau_1 \equiv \tau_2}
{\Gamma\typing{e}{\tau_2}{n}{s}}

\inferrule* [Right=Le]
{\Gamma\typing{e}{\tau}{n}{s} \\ n \leO n' \\ s \leq s'}
{\Gamma\typing{e}{\tau}{n'}{s'}}

\end{mathpar}
%% \caption{\label{opsem}Typing rules}
%% \end{figure}

\section{Types of constants}

\begin{align*}
\sympair&:\forall A,B.\;\arrow{\intro{x}{A}}{0}{1}{\arrow{\intro{y}{B}}{1}{(x,y)}{A\times B}} \\
\symleft&:\forall A,B.\;\arrow{\intro{x}{A}}{1}{\symSleft x}{A+B} \\
\symright&:\forall A,B.\;\arrow{\intro{x}{B}}{1}{\symSright x}{A+B} \\
\symtt&:\symunit
\end{align*}

\section{Derived typing rules}

\subsection{List}

\begin{align*}
\symlist &\defeq \Lambda A. \mu L. \symunit + \thide{A} \times L \\
\symnil &\defeq \lambda A. \symfold (\symlist\;A) \\
\symnil &: \forall^{1}_{\symSfold\;(\symSleft\;\symStt)} A. \symlist\;A \\
\symcons &\defeq \lambda A. \lambda(x : A)(y : \symlist\;A). \symfold (\symlist\;A)\;(\symright\;(\symhide x,y)) \\
\symcons &: \forall A. \arrow{\intro{x}{A}}{0}{1}{\arrow{\intro{y}{\symlist\;A}}{1}{\symSfold (\symSright (\symShide x, y))}{\symlist\;A}} 
\end{align*}

\begin{align*}
\symmatch_\symlist\; (e : \symlist\;A) \symwith \symnil \Rightarrow e_1 \;|\; \symcons\;x\;y \Rightarrow e_2 
  & \defeq \symmatch_\symsum\;(\symunfold (\symlist\;A)\;e) \symwith \\
  & \hspace{0.4in} |\;\symleft\;\_ \Rightarrow e_1 \\
  & \hspace{0.4in} |\; \symright\;p \Rightarrow \symmatch_\sympair\;(\symunhide A\;(\symfst\;p),\symsnd\;p)\symwith \\
  & \hspace{1.2in} |\; (x,y) \Rightarrow e_2
\end{align*}

$$
\inferrule* [Right=MatchList]
{\Gamma\typing{e}{\symlist\;\tau}{n}{s} \\ \mathsf{IsList}(s)=(s_1,s_2) \\ \Gamma\typing{e_1}{\tau'}{n_1}{s'} \\ \Gamma, x:(\tau,s_1), y:(\symlist\;\tau,s_2)\typing{e_2}{\tau'}{n_2}{s'} \\ x,y\not\in \FV(\tau')\cup\FV(s')}
{\Gamma\typing{\symmatch_\symlist\;e\symwith \symnil \Rightarrow e_1 \;|\; \symcons\;x\;y \Rightarrow e_2}{\tau'}{n+1+\symmax(n_1, n_2[s_1/x][s_2/y])}{s'}}
$$

\subsection{Fixpoint}

\begin{align*}
\symfix\;f:\tau\Rightarrow e &\defeq \symletrec f:\tau := e \symin f
\end{align*}

$$
\inferrule* [Right=Fix]
{\Gamma, f:(\tau, 1)\typing{e}{\tau}{0}{1} \\ f\not\in\FV(\tau)}
{\Gamma\typing{\symfix\;f:\tau\Rightarrow e}{\tau}{0}{1}}
$$

\subsection{Bool}

\begin{align*}
\symbool &\defeq \symunit + \symunit \\
\symtrue &\defeq \symleft\;\symtt \\
\symfalse &\defeq \symright\;\symtt \\
\symif e \symthen e_1 \symelse e_2 &\defeq \symmatch_\symsum\;e\symwith \symleft\;\_\Rightarrow e_1 \;|\; \symright\;\_\Rightarrow e_2
\end{align*}

$$
\inferrule* [Right=If]
{\Gamma\typing{e}{\symbool}{n}{s'} \\ \mathsf{IsLR}(s')=(s_1,s_2) \\ \forall i.\;\Gamma\typing{e_i}{\tau}{n_1}{s}}
{\Gamma\typing{\symif e \symthen e_1 \symelse e_2}{\tau}{n+1+\symmax(n_1,n_2)}{s}}
$$

\section{Examples}

\subsection{Merge sort}

\subsubsection{merge()}

\begin{align*}
\symmerge &\defeq \lambda A. \lambda (cmp:\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}}).\symfix\;(f:\arrow{\intro{xs}{\symlist\;A}}{0}{1}{\arrow{\intro{ys}{\symlist\;A}}{xs.1+ys.1}{xs+ys}{\symlist\;A}})\Rightarrow\lambda xs,ys. \\
& \hspace{0.3in} \symmatch\;xs\symwith \\
& \hspace{.4in} |\; \symnil\Rightarrow ys \\
& \hspace{.4in} |\; x::xs' \Rightarrow \symmatch\;ys\symwith \\
& \hspace{1.2in} |\; \symnil\Rightarrow xs \\
& \hspace{1.2in} |\; y::ys' \Rightarrow \symif cmp\;x\;y \symthen \\
& \hspace{2in} x :: f\;xs'\;ys \\
& \hspace{1.9in} \symelse \\
& \hspace{2in} y :: f\;xs\;ys' \\
\symmerge &: \forall A.\arrow{(\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}})}{0}{1}{\arrow{\intro{xs}{\symlist\;A}}{0}{1}{\arrow{\intro{ys}{\symlist\;A}}{xs.1+ys.1}{xs+ys}{\symlist\;A}}}
\end{align*}

\newpage

$$
\inferrule* [Right=Le]
{
  \inferrule* {\cdots}{\Gamma''\typing{x::f\;xs'\;ys}{\symlist\;A}{1+xs.\symuf.\symr.\syms.1+ys.1}{\symSfold (\symSright (\symShide xs.\symuf.\symr.\symf, (xs.\symuf.\symr.\syms+ys)))}} \\
  \inferrule*
  {\textcolor{red}{\forall i.\; 1+xs.\symuf.\symr.\syms.i+ys.i \leq xs.i+ys.i}}
  {\symSfold (\symSright (\symShide xs.\symuf.\symr.\symf, (xs.\symuf.\symr.\syms+ys))) \leq xs+ys}
}
{
  \textcolor{green}{(4)}
}
$$

$$
\inferrule* [Right=If]
{
  \inferrule* {\cdots}{\Gamma''\typing{cmp\;x\;y}{\symbool}{1}{\symSbool}} \\
  \inferrule*
  {
    \textcolor{green}{(4)}
  }
  {\Gamma''\typing{x::f\;xs'\;ys}{\symlist\;A}{1+xs.\symuf.\symr.\syms.1+ys.1}{xs+ys}} \\
  \inferrule* {\cdots}{\Gamma''\typing{y::f\;xs\;ys'}{\symlist\;A}{1+xs.1+ys.\symuf.\symr.\syms.1}{xs+ys}}
}
{
  \textcolor{green}{(3)}
}
$$

$$
\inferrule* [Right=MatchList]
{
  \Gamma'\typing{ys}{\symlist\;A}{0}{ys} \\
  \mathsf{IsList}(ys)=(ys.\symuf.\symr.\symf,ys.\symuf.\symr.\syms) \\
  \Gamma'\typing{xs}{\symlist\;A}{0}{xs+ys} \\
  \inferrule* [Right=If]
  {
    \textcolor{green}{(3)}
  }
  {
    \Gamma''\defeq\Gamma', y:(A,ys.\symuf.\symr.\symf), ys':(\symlist\;A,ys.\symuf.\symr.\syms)\typing{\symif cmp\;x\;y \symthen\dots}{\symlist\;A}{2+\symmax(\cdots)}{xs+ys}
  }
}
{
  \textcolor{green}{(2)}
}
$$

$$
\inferrule* [Right=MatchList]
{
  \inferrule* [Right=Var2] {\Gamma(xs)=(\symlist\;A,\bottom)} {\Gamma\typing{xs}{\symlist\;A}{0}{xs}}\\
  \mathsf{IsList}(xs)=(xs.\symuf.\symr.\symf,xs.\symuf.\symr.\syms) \\
  \inferrule* [Right=Le] {\Gamma\typing{ys}{\symlist\;A}{0}{ys} \\ \textcolor{red}{ys \leq xs+ys}}{\Gamma\typing{ys}{\symlist\;A}{0}{xs+ys}} \\
  \inferrule* [Right=MatchList]
  {
    \textcolor{green}{(2)}
  }
  {
    \Gamma'\defeq\Gamma, x:(A,xs.\symuf.\symr.\symf), xs':(\symlist\;A,xs.\symuf.\symr.\syms)\typing{\symmatch\;ys\symwith\dots}{\symlist\;A}{2+\symmax(\cdots)}{xs+ys}
  }
}
{
  \textcolor{green}{(1)}
}
$$

$$
\inferrule* [Right=Tabs; Abs; Fix; Abs; Abs; Le]
{
  \inferrule* [Right=MatchList]
  {
    \textcolor{green}{(1)}
  }
  {
    \Gamma\defeq A:*, cmp:(\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}}, \bottom), f:(\arrow{\intro{xs}{\symlist\;A}}{0}{1}{\arrow{\intro{ys}{\symlist\;A}}{xs.1+ys.1}{xs+ys}{\symlist\;A}}, 1), xs:(\symlist\;A,\bottom), ys:(\symlist\;A,\bottom)\typing{\symmatch\;xs\symwith\dots}{\symlist;A}{2+\symmax(\cdots)}{xs+ys}
  } \\
  \textcolor{red}{2+\symmax(1+xs.\symuf.\symr.\syms.1+ys.1, 1+xs+ys.\symuf.\symr.\syms.1) \leO xs.1+ys.1}
}
{\typing{\symmerge}{\forall A.\arrow{(\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}})}{0}{1}{\arrow{\intro{xs}{\symlist\;A}}{0}{1}{\arrow{\intro{ys}{\symlist\;A}}{xs.1+ys.1}{xs+ys}{\symlist\;A}}}}{0}{1}}
$$

\newpage

\subsubsection{split()}

\begin{align*}
\symsplit &\defeq \lambda A. \symfix\;(f:\arrow{\intro{s}{\symlist\;A}}{s.1/2}{(s/2,s/2)}{\symlist\;A\times\symlist\;A})\Rightarrow\lambda xs. \\
& \hspace{0.3in} \symmatch\;xs\symwith \\
& \hspace{.4in} |\; \symnil\Rightarrow (\symnil,\symnil) \\
& \hspace{.4in} |\; x::xs' \Rightarrow \symmatch\;xs'\symwith \\
& \hspace{1.2in} |\; \symnil\Rightarrow (x::\symnil,\symnil) \\
& \hspace{1.2in} |\; y::xs'' \Rightarrow \symmatch\; f\;xs'' \symwith \\
& \hspace{2in} |\; (a, b) \Rightarrow (x::a,y::b) \\
\symsplit &: \forall A.\arrow{\intro{s}{\symlist\;A}}{s.1/2}{(s/2,s/2)}{\symlist\;A\times\symlist\;A}
\end{align*}

%% \newpage

$$
\inferrule* [Right=MatchList]
{
  \Gamma\typing{xs}{\symlist\;A}{0}{xs} \\
  \mathsf{IsList}(xs)=(xs.\symuf.\symr.\symf,xs.\symuf.\symr.\syms) \\
  \inferrule* [Right=Le] {\Gamma\typing{(\symnil,\symnil)}{\symlist\;A\times\symlist\;A}{1}{(1,1)} \\ \textcolor{red}{(1,1) \leq (xs/2,xs/2)}}{\Gamma\typing{(\symnil,\symnil)}{\symlist\;A\times\symlist\;A}{1}{(xs/2, xs/2)}} \\
  \inferrule* {\textcolor{green}{(2)}}{\Gamma'\defeq\Gamma, xs':(\symlist\;A,xs.\symuf.\symr.\syms)\typing{\symmatch\;xs'\symwith\dots}{\symlist\;A\times\symlist\;A}{n}{(xs/2,xs/2)}}
}
{\textcolor{green}{(1)}}
$$

$$
\inferrule* [Right=Tabs;Fix;Abs;Le]
{
  \inferrule* [Right=MatchList]
  {
    \textcolor{green}{(1)}
  }
  {
    \Gamma\defeq A:*, f:(\arrow{\intro{s}{\symlist\;A}}{s.1/2}{(s/2,s/2)}{\symlist\;A\times\symlist\;A}, 1), xs:(\symlist\;A,\bottom)\typing{\symmatch\;xs\symwith\dots}{\symlist\;A\times\symlist\;A}{?}{(xs/2, xs/2)}
  } \\
  \textcolor{red}{n\defeq ? \leO xs.1/2}
}
{\typing{\symsplit}{\forall A.\arrow{\intro{s}{\symlist\;A}}{s.1/2}{(s/2,s/2)}{\symlist\;A\times\symlist\;A}}{0}{1}}
$$

\newpage

\subsubsection{msort()}

\begin{align*}
\symmsort &\defeq \lambda A. \lambda (cmp:\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}}).\symfix\;(f:\arrow{\intro{s}{\symlist\;A}}{s.1*\log(s.1)}{\symSstat(s.1,s.2)}{\symlist\;A})\Rightarrow\lambda xs. \\
& \hspace{0.3in} \symmatch\;xs\symwith \\
& \hspace{.4in} |\; \symnil\Rightarrow xs \\
& \hspace{.4in} |\; \_::xs' \Rightarrow \symmatch\;xs'\symwith \\
& \hspace{1.2in} |\; \symnil\Rightarrow xs \\
& \hspace{1.2in} |\; \_ \Rightarrow \symmatch\; \symsplit\;xs \symwith \\
& \hspace{1.8in} |\; (ys, zs) \Rightarrow \symmerge\;(f\;ys)\;(f\;zs) \\
\symmsort &: \forall A.\arrow{(\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}})}{0}{1}{\arrow{\intro{s}{\symlist\;A}}{s.1*\log(s.1)}{\symSstat(s.1,s.2)}{\symlist\;A}}
\end{align*}

\newpage

$$
\inferrule* [Right=Le]
{
  \inferrule* {\cdots}{\Gamma''\typing{\symmerge\;(f\;ys)\;(f\;zs)}{\symlist\;A}{n}{\symSstat(xs.1/2+xs.1/2,xs.2/2+xs.2/2)}} \\
  \inferrule*
  {\textcolor{red}{\forall i.\; xs.i/2+xs.i/2 \leq xs.i}}
  {\symSstat(xs.1/2+xs.1/2,xs.2/2+xs.2/2) \leq \symSstat(xs.1,xs.2)}
}
{\textcolor{green}{(4)}}
$$

$$
\inferrule* [Right=MatchPair]
{
  \Gamma\typing{\symsplit\;xs}{\symlist\;A}{xs.1/2}{(xs/2, xs/2)} \\
  \mathsf{IsPair}(xs/2,xs/2)=(xs/2,xs/2) \\
  \inferrule* {\textcolor{green}{(4)}}{\Gamma''\defeq\Gamma',ys:(\symlist\;A,xs/2),zs:(\symlist\;A,xs/2)\typing{\symmerge\;(f\;ys)\;(f\;zs)}{\symlist\;A}{n}{\symSstat(xs.1,xs.2)}}
}
{\textcolor{green}{(3)}}
$$

$$
\inferrule* [Right=MatchList]
{
  \Gamma\typing{xs'}{\symlist\;A}{0}{xs'} \\
  \mathsf{IsList}(xs')=(xs'.\symuf.\symr.\symf,xs'.\symuf.\symr.\syms) \\
  \Gamma\typing{xs}{\symlist\;A}{0}{\symSstat(xs.1,xs.2)} \\
  \inferrule* {\textcolor{green}{(3)}}{\Gamma'\typing{\symmatch\;\symsplit\;xs\symwith\dots}{\symlist\;A}{n}{\symSstat(xs.1,xs.2)}}
}
{\textcolor{green}{(2)}}
$$

$$
\inferrule* [Right=MatchList]
{
  \Gamma\typing{xs}{\symlist\;A}{0}{xs} \\
  \mathsf{IsList}(xs)=(xs.\symuf.\symr.\symf,xs.\symuf.\symr.\syms) \\
  \inferrule* [Right=Le] {\Gamma\typing{xs}{\symlist\;A}{0}{xs} \\ \textcolor{red}{xs \leq \symSstat(xs.1,xs.2)}}{\Gamma\typing{xs}{\symlist\;A}{0}{\symSstat(xs.1,xs.2)}} \\
  \inferrule* {\textcolor{green}{(2)}}{\Gamma'\defeq\Gamma, xs':(\symlist\;A,xs.\symuf.\symr.\syms)\typing{\symmatch\;xs'\symwith\dots}{\symlist\;A}{n}{\symSstat(xs.1,xs.2)}}
}
{\textcolor{green}{(1)}}
$$

$$
\inferrule* [Right=Tabs;Abs;Fix;Abs;Le]
{
  \inferrule* [Right=MatchList]
  {\textcolor{green}{(1)}}
  {\Gamma\defeq A:*, cmp:(\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}}, \bottom), f:(\arrow{\intro{s}{\symlist\;A}}{s.1*\log(s.1)}{\symSstat(s.1,s.2)}{\symlist\;A}, 1), xs:(\symlist\;A,\bottom) \typing{\symmatch\;xs\symwith\dots}{\symlist\;A}{n}{\symSstat(xs.1,xs.2)}} \\
  \textcolor{red}{n\defeq xs.1/2*\log(xs.1/2)+xs.1/2*\log(xs.1/2)+1+xs.1/2+xs.1/2 \leO xs.1*\log(xs.1)}
}
{\typing{\symmsort}{\forall A.\arrow{(\arrow{A}{0}{1}{\arrow{A}{1}{\symSbool}{\symbool}})}{0}{1}{\arrow{\intro{s}{\symlist\;A}}{s.1*\log(s.1)}{\symSstat(s.1,s.2)}{\symlist\;A}}}{0}{1}}
$$

\newpage

\end{document}
